public with sharing class DesignPartnerRecommendationController {
  @AuraEnabled(cacheable=true)
  public static String simpleTest() {
    System.debug('=== simpleTest í˜¸ì¶œë¨ ===');
    return 'Test ì„±ê³µ';
  }

  @AuraEnabled(cacheable=true)
  public static Map<String, Object> getRecommendationData(Id opportunityId) {
    System.debug('=== getRecommendationData ë©”ì†Œë“œ í˜¸ì¶œë¨ ===');
    System.debug('opportunityId: ' + opportunityId);

    try {
      // Opportunity ì •ë³´ ì¡°íšŒ - í•„ìš”í•œ í•„ë“œë§Œ
      Opportunity opp = [
        SELECT
          Id,
          Name,
          Customer_Design_Preference__c,
          Budget__c,
          ProjectType__c,
          RecommendationDate__c,
          sf_product__c
        FROM Opportunity
        WHERE Id = :opportunityId
        LIMIT 1
      ];

      System.debug('Opportunity ProjectType__c: ' + opp.ProjectType__c);
      System.debug(
        'Customer Design Preference: ' + opp.Customer_Design_Preference__c
      );
      System.debug('SF Product: ' + opp.sf_product__c);

      // ë””ìì¸ íŒŒíŠ¸ë„ˆì‚¬ ëª©ë¡ ì¡°íšŒ - 3ê°€ì§€ ì¡°ê±´ ë§¤ì¹­ ìš°ì„ ìˆœìœ„ ì ìš© (ProjectType, Design Style, Product)
      // 1ìˆœìœ„: 3ê°œ ì¡°ê±´ ëª¨ë‘ ë§¤ì¹­
      List<Account> perfectMatchPartners = [
        SELECT
          Id,
          Name,
          Design_Style_Specialties__c,
          AccountRole__c,
          PartnerSpecialty__c,
          PartnerRating__c
        FROM Account
        WHERE
          AccountRole__c = :opp.ProjectType__c
          AND Design_Style_Specialties__c = :opp.Customer_Design_Preference__c
          AND PartnerSpecialty__c = :opp.sf_product__c
        ORDER BY PartnerRating__c DESC NULLS LAST, Name
        LIMIT 3
      ];

      // 2ìˆœìœ„: 2ê°œ ì¡°ê±´ ë§¤ì¹­ (ProjectType + Design Style)
      List<Account> twoMatchPartners = new List<Account>();
      if (perfectMatchPartners.size() < 3) {
        Integer remainingLimit = 3 - perfectMatchPartners.size();
        twoMatchPartners = [
          SELECT
            Id,
            Name,
            Design_Style_Specialties__c,
            AccountRole__c,
            PartnerSpecialty__c,
            PartnerRating__c
          FROM Account
          WHERE
            AccountRole__c = :opp.ProjectType__c
            AND Design_Style_Specialties__c = :opp.Customer_Design_Preference__c
            AND (PartnerSpecialty__c != :opp.sf_product__c
            OR PartnerSpecialty__c = NULL)
          ORDER BY PartnerRating__c DESC NULLS LAST, Name
          LIMIT :remainingLimit
        ];
      }

      // 3ìˆœìœ„: 1ê°œ ì¡°ê±´ë§Œ ë§¤ì¹­ë˜ëŠ” íŒŒíŠ¸ë„ˆ (ProjectType ìš°ì„ )
      List<Account> oneMatchPartners = new List<Account>();
      if (perfectMatchPartners.size() + twoMatchPartners.size() < 3) {
        Integer remainingLimit =
          3 -
          perfectMatchPartners.size() -
          twoMatchPartners.size();
        oneMatchPartners = [
          SELECT
            Id,
            Name,
            Design_Style_Specialties__c,
            AccountRole__c,
            PartnerSpecialty__c,
            PartnerRating__c
          FROM Account
          WHERE
            AccountRole__c = :opp.ProjectType__c
            AND (Design_Style_Specialties__c != :opp.Customer_Design_Preference__c
            OR Design_Style_Specialties__c = NULL)
            AND (PartnerSpecialty__c != :opp.sf_product__c
            OR PartnerSpecialty__c = NULL)
          ORDER BY PartnerRating__c DESC NULLS LAST, Name
          LIMIT :remainingLimit
        ];
      }

      // 4ìˆœìœ„: ì¼ë°˜ íŒŒíŠ¸ë„ˆë“¤
      List<Account> otherPartners = new List<Account>();
      if (
        perfectMatchPartners.size() + twoMatchPartners.size() +
        oneMatchPartners.size() < 3
      ) {
        Integer remainingLimit =
          3 -
          perfectMatchPartners.size() -
          twoMatchPartners.size() -
          oneMatchPartners.size();
        otherPartners = [
          SELECT
            Id,
            Name,
            Design_Style_Specialties__c,
            AccountRole__c,
            PartnerSpecialty__c,
            PartnerRating__c
          FROM Account
          WHERE
            AccountRole__c IN ('ì‹œê³µì—…ì²´', 'ë¦¬ëª¨ë¸ë§', 'ì¸í…Œë¦¬ì–´')
            AND AccountRole__c != :opp.ProjectType__c
            AND (Design_Style_Specialties__c != :opp.Customer_Design_Preference__c
            OR Design_Style_Specialties__c = NULL)
            AND (PartnerSpecialty__c != :opp.sf_product__c
            OR PartnerSpecialty__c = NULL)
          ORDER BY PartnerRating__c DESC NULLS LAST, Name
          LIMIT :remainingLimit
        ];
      }

      // ìµœì¢… íŒŒíŠ¸ë„ˆ ëª©ë¡ ìƒì„± (ìš°ì„ ìˆœìœ„ëŒ€ë¡œ)
      List<Account> partners = new List<Account>();
      partners.addAll(perfectMatchPartners);
      partners.addAll(twoMatchPartners);
      partners.addAll(oneMatchPartners);
      partners.addAll(otherPartners);

      System.debug('ë””ìì¸ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ê²°ê³¼: ' + partners.size() + 'ê°œ');
      System.debug(
        '1ìˆœìœ„(Perfect Match): ' + perfectMatchPartners.size() + 'ê°œ'
      );
      System.debug('2ìˆœìœ„(Two Match): ' + twoMatchPartners.size() + 'ê°œ');
      System.debug('3ìˆœìœ„(One Match): ' + oneMatchPartners.size() + 'ê°œ');
      System.debug('4ìˆœìœ„(Other Partners): ' + otherPartners.size() + 'ê°œ');

      // íŒŒíŠ¸ë„ˆ ì •ë³´ ë¡œê¹… ë° ë§¤ì¹­ ì—¬ë¶€ í™•ì¸
      for (Integer i = 0; i < partners.size(); i++) {
        Account partner = partners[i];
        Boolean isProjectTypeMatched =
          partner.AccountRole__c == opp.ProjectType__c;
        Boolean isDesignStyleMatched =
          partner.Design_Style_Specialties__c ==
          opp.Customer_Design_Preference__c;
        Boolean isPartnerSpecialtyMatched =
          partner.PartnerSpecialty__c == opp.sf_product__c;

        // ë§¤ì¹­ëœ ì¡°ê±´ ê°œìˆ˜ ê³„ì‚°
        Integer matchCount = 0;
        if (isProjectTypeMatched)
          matchCount++;
        if (isDesignStyleMatched)
          matchCount++;
        if (isPartnerSpecialtyMatched)
          matchCount++;

        String matchType = '';
        if (matchCount == 3) {
          matchType = '1ìˆœìœ„(3/3 ì™„ë²½ë§¤ì¹­)';
        } else if (matchCount == 2) {
          matchType = '2ìˆœìœ„(2/3 ë§¤ì¹­)';
        } else if (matchCount == 1) {
          matchType = '3ìˆœìœ„(1/3 ë§¤ì¹­)';
        } else {
          matchType = '4ìˆœìœ„(ì¼ë°˜)';
        }

        System.debug(
          'íŒŒíŠ¸ë„ˆ ì •ë³´ [' +
            (i + 1) +
            '] - ì´ë¦„: ' +
            partner.Name +
            ', ì—­í• : ' +
            partner.AccountRole__c +
            ', í‰ì : ' +
            partner.PartnerRating__c +
            ', ì „ë¬¸ë¶„ì•¼: ' +
            partner.PartnerSpecialty__c +
            ', ë””ìì¸ìŠ¤íƒ€ì¼: ' +
            partner.Design_Style_Specialties__c +
            ', ë§¤ì¹­íƒ€ì…: ' +
            matchType +
            ', ë§¤ì¹­ê°œìˆ˜: ' +
            matchCount +
            '/3'
        );
      }

      // AI ì¶”ì²œ ìƒì„± (Prompt Builder í™œìš©)
      String aiRecommendation = generateAIRecommendation(opp, partners);

      Map<String, Object> result = new Map<String, Object>();
      result.put('opportunity', opp);
      result.put('partners', partners);
      result.put('aiRecommendation', aiRecommendation);
      return result;
    } catch (Exception e) {
      throw new AuraHandledException('ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage());
    }
  }

  // AI ì¶”ì²œ ìƒì„± ë©”ì†Œë“œ (Prompt Builder í™œìš©)
  private static String generateAIRecommendation(
    Opportunity opp,
    List<Account> partners
  ) {
    try {
      // íŒŒíŠ¸ë„ˆ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
      String partnerListStr = formatPartnersForPrompt(partners);

      // Prompt Builder í˜¸ì¶œì„ ìœ„í•œ ì…ë ¥ê°’ ì„¤ì •
      Map<String, Object> inputs = new Map<String, Object>();
      inputs.put('OpportunityName', opp.Name);
      inputs.put(
        'ProjectType',
        opp.ProjectType__c != null ? opp.ProjectType__c : 'ë¯¸ì •'
      );
      inputs.put(
        'DesignPreference',
        opp.Customer_Design_Preference__c != null
          ? opp.Customer_Design_Preference__c
          : 'ë¯¸ì •'
      );
      inputs.put(
        'ProductType',
        opp.sf_product__c != null ? opp.sf_product__c : 'ë¯¸ì •'
      );
      inputs.put(
        'Budget',
        opp.Budget__c != null ? String.valueOf(opp.Budget__c) + 'ì›' : 'ë¯¸ì •'
      );
      inputs.put('PartnerList', partnerListStr);

      System.debug('AI í”„ë¡¬í”„íŠ¸ ì…ë ¥ê°’: ' + inputs);

      // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì•„ë˜ ì½”ë“œë¡œ Prompt Builder í˜¸ì¶œ
      /*
      ConnectApi.EinsteinPromptTemplateGenerationsInput promptInput = 
          new ConnectApi.EinsteinPromptTemplateGenerationsInput();
      promptInput.inputParams = inputs;
      
      ConnectApi.EinsteinPromptTemplateGenerationsRepresentation response = 
          ConnectApi.EinsteinAI.generatePromptTemplate('YOUR_PROMPT_TEMPLATE_ID', promptInput);
      
      return response.generation.text;
      */

      // ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©
      return generateAdvancedRecommendation(opp, partners);
    } catch (Exception e) {
      System.debug('AI ì¶”ì²œ ìƒì„± ì˜¤ë¥˜: ' + e.getMessage());
      // AI í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì¶”ì²œ ë¡œì§ ì‚¬ìš©
      return generateBasicRecommendation(opp, partners);
    }
  }

  // íŒŒíŠ¸ë„ˆ ì •ë³´ë¥¼ í”„ë¡¬í”„íŠ¸ìš© ë¬¸ìì—´ë¡œ ë³€í™˜
  private static String formatPartnersForPrompt(List<Account> partners) {
    String result = '';
    for (Integer i = 0; i < partners.size(); i++) {
      Account partner = partners[i];
      result += (i + 1) + '. **' + partner.Name + '**\n';
      result +=
        '   - ì „ë¬¸ë¶„ì•¼: ' +
        (partner.AccountRole__c != null ? partner.AccountRole__c : 'ë¯¸ë¶„ë¥˜') +
        '\n';
      result +=
        '   - ë””ìì¸ ìŠ¤íƒ€ì¼: ' +
        (partner.Design_Style_Specialties__c != null
          ? partner.Design_Style_Specialties__c
          : 'ë‹¤ì–‘') +
        '\n';
      result +=
        '   - íŠ¹ì¥ì : ' +
        (partner.PartnerSpecialty__c != null
          ? partner.PartnerSpecialty__c
          : 'ì¢…í•© ì„œë¹„ìŠ¤') +
        '\n';
      result +=
        '   - í‰ì : ' +
        (partner.PartnerRating__c != null
          ? String.valueOf(partner.PartnerRating__c) + 'ì '
          : 'í‰ê°€ ì¤‘') +
        '\n\n';
    }
    return result;
  }

  // ê³ ê¸‰ AI ì‹œë®¬ë ˆì´ì…˜ ì¶”ì²œ (Prompt Builder ìŠ¤íƒ€ì¼)
  private static String generateAdvancedRecommendation(
    Opportunity opp,
    List<Account> partners
  ) {
    String result = 'ğŸ¤– AI ì¶”ì²œ ë¶„ì„ ê²°ê³¼\n\n';

    // ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° ë° ì •ë ¬
    List<PartnerMatch> matches = new List<PartnerMatch>();
    for (Account partner : partners) {
      Integer score = calculateAdvancedMatchScore(opp, partner);
      String reason = generateDetailedReason(opp, partner, score);
      matches.add(new PartnerMatch(partner, score, reason));
    }
    matches.sort();

    // í”„ë¡œì íŠ¸ ë¶„ì„
    result += 'ğŸ“Š **í”„ë¡œì íŠ¸ ë¶„ì„**\n';
    result += '- í”„ë¡œì íŠ¸: ' + opp.Name + '\n';
    result +=
      '- ìœ í˜•: ' +
      (opp.ProjectType__c != null ? opp.ProjectType__c : 'ë¯¸ì •') +
      '\n';
    result +=
      '- ìŠ¤íƒ€ì¼: ' +
      (opp.Customer_Design_Preference__c != null
        ? opp.Customer_Design_Preference__c
        : 'ë¯¸ì •') +
      '\n';
    result +=
      '- ì œí’ˆ: ' +
      (opp.sf_product__c != null ? opp.sf_product__c : 'ë¯¸ì •') +
      '\n\n';

    // Top 3 ì¶”ì²œ
    result += 'ğŸ¯ **ì¶”ì²œ íŒŒíŠ¸ë„ˆ (ìƒìœ„ 3ê³³)**\n\n';
    for (Integer i = 0; i < Math.min(3, matches.size()); i++) {
      PartnerMatch match = matches[i];
      Account partner = match.partner;

      String icon = i == 0 ? 'ğŸ¥‡' : i == 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
      String priority = i == 0 ? 'ìµœìš°ì„  ì¶”ì²œ' : i == 1 ? 'ê°•ë ¥ ì¶”ì²œ' : 'ì¶”ì²œ';

      result +=
        icon +
        ' **' +
        (i + 1) +
        'ìˆœìœ„: ' +
        partner.Name +
        '** (' +
        priority +
        ')\n';
      result += 'ğŸ“Š ë§¤ì¹­ì ìˆ˜: ' + match.score + '/100ì \n';
      result += 'ğŸ’¡ ì¶”ì²œì´ìœ : ' + match.reason + '\n';
      result += 'â­ íŠ¹ì§•: ' + getPartnerStrengths(partner) + '\n\n';
    }

    // ìµœì¢… ì¡°ì–¸
    result += 'ğŸ’¼ **ì„ íƒ ê°€ì´ë“œ**\n';
    result += generateSelectionGuide(opp, matches);

    return result;
  }

  // AI í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•  ê¸°ë³¸ ì¶”ì²œ ë¡œì§
  private static String generateBasicRecommendation(
    Opportunity opp,
    List<Account> partners
  ) {
    String result = 'ğŸ¤– ê¸°ë³¸ ì¶”ì²œ ì‹œìŠ¤í…œ\n\n';

    for (Integer i = 0; i < Math.min(3, partners.size()); i++) {
      Account partner = partners[i];
      String icon = i == 0 ? 'ğŸ¥‡' : i == 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';

      result += icon + ' ' + (i + 1) + 'ìˆœìœ„: ' + partner.Name + '\n';
      result +=
        'ğŸ“Š í‰ì : ' +
        (partner.PartnerRating__c != null
          ? String.valueOf(partner.PartnerRating__c) + 'ì '
          : 'í‰ê°€ ì¤‘') +
        '\n';
      result += 'ğŸ’¡ ì¶”ì²œ ì´ìœ : ';

      // ê°„ë‹¨í•œ ë§¤ì¹­ ë¡œì§
      if (partner.AccountRole__c == opp.ProjectType__c) {
        result += 'í”„ë¡œì íŠ¸ ìœ í˜•ì— íŠ¹í™”ëœ ì „ë¬¸ ì—…ì²´';
      } else {
        result += 'ì¢…í•©ì ì¸ ì„œë¹„ìŠ¤ ì—­ëŸ‰ì„ ê°–ì¶˜ ì—…ì²´';
      }
      result += '\n\n';
    }

    return result;
  }

  // ê³ ê¸‰ ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° (ê°œì„ ëœ ë²„ì „)
  private static Integer calculateAdvancedMatchScore(
    Opportunity opp,
    Account partner
  ) {
    Integer score = 0;

    // ê¸°ë³¸ ì ìˆ˜ (ëª¨ë“  íŒŒíŠ¸ë„ˆì—ê²Œ 20ì  ì§€ê¸‰)
    score += 20;

    // 1. í”„ë¡œì íŠ¸ íƒ€ì… ë§¤ì¹­ (30ì )
    if (partner.AccountRole__c == opp.ProjectType__c) {
      score += 30; // ì™„ë²½ ë§¤ì¹­
    } else if (partner.AccountRole__c != null && opp.ProjectType__c != null) {
      // ìœ ì‚¬ ë¶„ì•¼ ë³´ë„ˆìŠ¤ (20ì )
      if (isRelatedField(partner.AccountRole__c, opp.ProjectType__c)) {
        score += 20;
      } else {
        // ë‹¤ë¥¸ ë””ìì¸ ë¶„ì•¼ë¼ë„ ê¸°ë³¸ ì ìˆ˜ (10ì )
        score += 10;
      }
    }

    // 2. ë””ìì¸ ìŠ¤íƒ€ì¼ ë§¤ì¹­ (25ì )
    if (
      partner.Design_Style_Specialties__c == opp.Customer_Design_Preference__c
    ) {
      score += 25;
    } else if (partner.Design_Style_Specialties__c != null) {
      // ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì´ë¼ë„ ì „ë¬¸ì„± ì¸ì • (10ì )
      score += 10;
    }

    // 3. ì œí’ˆ ì „ë¬¸ì„± ë§¤ì¹­ (15ì )
    if (partner.PartnerSpecialty__c == opp.sf_product__c) {
      score += 15;
    } else if (partner.PartnerSpecialty__c != null) {
      // ë‹¤ë¥¸ ì œí’ˆ ì „ë¬¸ì„±ì´ë¼ë„ ê¸°ë³¸ ì ìˆ˜ (7ì )
      score += 7;
    }

    // 4. í‰ì  ë³´ë„ˆìŠ¤ (ìµœëŒ€ 10ì )
    if (partner.PartnerRating__c != null) {
      score += Integer.valueOf(partner.PartnerRating__c * 2); // 5ì  ë§Œì ì„ 10ì ìœ¼ë¡œ ë³€í™˜
    } else {
      // í‰ì ì´ ì—†ì–´ë„ ê¸°ë³¸ ì ìˆ˜ (5ì )
      score += 5;
    }

    return Math.min(score, 100); // ìµœëŒ€ 100ì 
  }
  // ìœ ì‚¬ ë¶„ì•¼ íŒë³„
  private static Boolean isRelatedField(
    String partnerRole,
    String projectType
  ) {
    Set<String> constructionFields = new Set<String>{
      'ì‹œê³µì—…ì²´',
      'ê±´ì„¤ì—…ì²´',
      'ë¦¬ëª¨ë¸ë§'
    };
    Set<String> designFields = new Set<String>{ 'ì¸í…Œë¦¬ì–´', 'ë””ìì¸', 'ì‹œê³µ' };

    return (constructionFields.contains(partnerRole) &&
      constructionFields.contains(projectType)) ||
      (designFields.contains(partnerRole) &&
      designFields.contains(projectType));
  }

  // ìƒì„¸ ì¶”ì²œ ì´ìœ  ìƒì„±
  private static String generateDetailedReason(
    Opportunity opp,
    Account partner,
    Integer score
  ) {
    List<String> reasons = new List<String>();

    if (partner.AccountRole__c == opp.ProjectType__c) {
      reasons.add('í”„ë¡œì íŠ¸ ìœ í˜•(' + opp.ProjectType__c + ')ì— ì™„ë²½ ë§¤ì¹­');
    } else if (isRelatedField(partner.AccountRole__c, opp.ProjectType__c)) {
      reasons.add('ê´€ë ¨ ë¶„ì•¼ ì „ë¬¸ì„± ë³´ìœ ');
    }

    if (
      partner.Design_Style_Specialties__c == opp.Customer_Design_Preference__c
    ) {
      reasons.add(
        'ì„ í˜¸ ë””ìì¸(' + opp.Customer_Design_Preference__c + ') ì „ë¬¸ê°€'
      );
    }

    if (partner.PartnerSpecialty__c == opp.sf_product__c) {
      reasons.add('ìš”êµ¬ ì œí’ˆ(' + opp.sf_product__c + ') ì „ë¬¸ ê²½í—˜');
    }

    if (partner.PartnerRating__c != null && partner.PartnerRating__c >= 4.0) {
      reasons.add('ê²€ì¦ëœ ê³ ê° ë§Œì¡±ë„(' + partner.PartnerRating__c + 'ì )');
    }

    if (reasons.isEmpty()) {
      return 'ì¢…í•©ì ì¸ ì„œë¹„ìŠ¤ ì—­ëŸ‰ê³¼ ì•ˆì •ì ì¸ ì‚¬ì—… ìš´ì˜';
    }

    return String.join(reasons, ', ');
  }

  // íŒŒíŠ¸ë„ˆ ê°•ì  ë¶„ì„
  private static String getPartnerStrengths(Account partner) {
    List<String> strengths = new List<String>();

    if (partner.PartnerRating__c != null && partner.PartnerRating__c >= 4.5) {
      strengths.add('í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ í’ˆì§ˆ');
    }

    if (partner.AccountRole__c == 'ì‹œê³µì—…ì²´') {
      strengths.add('ì „ë¬¸ ì‹œê³µ ê¸°ìˆ ë ¥');
    } else if (partner.AccountRole__c == 'ì¸í…Œë¦¬ì–´') {
      strengths.add('ì°½ì˜ì  ë””ìì¸ ì—­ëŸ‰');
    } else if (partner.AccountRole__c == 'ë¦¬ëª¨ë¸ë§') {
      strengths.add('ê¸°ì¡´ ê³µê°„ ìµœì í™” ë…¸í•˜ìš°');
    }

    if (partner.Design_Style_Specialties__c != null) {
      strengths.add(partner.Design_Style_Specialties__c + ' ìŠ¤íƒ€ì¼ ì „ë¬¸ì„±');
    }

    return strengths.isEmpty()
      ? 'ë‹¤ë…„ê°„ì˜ ì—…ê³„ ê²½í—˜'
      : String.join(strengths, ', ');
  }

  // ì„ íƒ ê°€ì´ë“œ ìƒì„±
  private static String generateSelectionGuide(
    Opportunity opp,
    List<PartnerMatch> matches
  ) {
    String guide = '';

    if (matches.size() > 0 && matches[0].score >= 80) {
      guide += '1ìˆœìœ„ íŒŒíŠ¸ë„ˆëŠ” í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­ê³¼ ë†’ì€ ì¼ì¹˜ë„ë¥¼ ë³´ì´ë¯€ë¡œ ìš°ì„  ê²€í† ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤. ';
    }

    if (opp.Budget__c != null) {
      guide += 'ì˜ˆì‚° ë²”ìœ„ ë‚´ì—ì„œ ê²¬ì ì„ ë¹„êµí•˜ì‹œê³ , ';
    }

    guide += 'ê° íŒŒíŠ¸ë„ˆì˜ í¬íŠ¸í´ë¦¬ì˜¤ì™€ ê³¼ê±° í”„ë¡œì íŠ¸ ì‚¬ë¡€ë¥¼ í™•ì¸í•˜ì—¬ ìµœì¢… ê²°ì •í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.';

    return guide;
  }

  // ë§¤ì¹­ ê²°ê³¼ë¥¼ ë‹´ëŠ” ë‚´ë¶€ í´ë˜ìŠ¤
  private class PartnerMatch implements Comparable {
    public Account partner;
    public Integer score;
    public String reason;

    public PartnerMatch(Account partner, Integer score, String reason) {
      this.partner = partner;
      this.score = score;
      this.reason = reason;
    }

    public Integer compareTo(Object other) {
      PartnerMatch otherMatch = (PartnerMatch) other;
      return otherMatch.score - this.score; // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    }
  }
}
