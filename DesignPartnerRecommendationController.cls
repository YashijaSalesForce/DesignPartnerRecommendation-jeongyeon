public with sharing class DesignPartnerRecommendationController {
  @AuraEnabled
  public static String getRecommendation(String inputData) {
    try {
      Map<String, Object> input = (Map<String, Object>) JSON.deserializeUntyped(
        inputData
      );

      // Opportunity ì •ë³´ ì¡°íšŒ
      String opportunityId = (String) input.get('opportunityId');
      Opportunity opp = [
        SELECT
          Id,
          Name,
          StageName,
          Amount,
          CloseDate,
          Description,
          ProjectType__c,
          sf_product__c,
          Account.Name,
          Account.Industry,
          Account.BillingCity,
          Account.BillingState
        FROM Opportunity
        WHERE Id = :opportunityId
      ];

      // ë””ìì¸ íŒŒíŠ¸ë„ˆì‚¬ ëª©ë¡ ì¡°íšŒ
      List<Account> partners = [
        SELECT
          Id,
          Name,
          AccountRole__c,
          ABillingCity__c,
          BillingState,
          Industry,
          Description,
          PartnerSpecialty__c,
          PartnerRating__c
        FROM Account
        WHERE
          IsPartner__c = 'íŒŒíŠ¸ë„ˆê³ ê°'
          AND AccountRole__c IN ('ì¸í…Œë¦¬ì–´', 'ì‹œê³µì—…ì²´')
        ORDER BY PartnerRating__c DESC NULLS LAST, ABillingCity__c
      ];

      System.debug('íŒŒíŠ¸ë„ˆì‚¬ ì¡°íšŒ ê²°ê³¼: ' + partners.size() + 'ê°œ');

      String recommendation = '';

      // ì‹¤ì œ AI ë¡œì§ (Prompt Builder ìŠ¤íƒ€ì¼)
      recommendation = generateAIRecommendation(opp, partners);

      // ì¶”ì²œ ìƒì„± ì¼ì‹œ ì—…ë°ì´íŠ¸
      opp.RecommendationDate__c = System.now();
      update opp;

      return recommendation;
    } catch (Exception e) {
      throw new AuraHandledException(
        'ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.getMessage()
      );
    }
  }

  // AI ìŠ¤íƒ€ì¼ ì¶”ì²œ ë¡œì§ (Prompt Builder ê²°ê³¼ì™€ ìœ ì‚¬í•˜ê²Œ)
  private static String generateAIRecommendation(
    Opportunity opp,
    List<Account> partners
  ) {
    if (partners.isEmpty()) {
      return 'í˜„ì¬ ì´ìš© ê°€ëŠ¥í•œ ë””ìì¸ íŒŒíŠ¸ë„ˆì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }

    // ìµœì  íŒŒíŠ¸ë„ˆì‚¬ ì„ ì • ë¡œì§
    Account bestPartner = findBestPartner(opp, partners);

    // AI ìŠ¤íƒ€ì¼ ì‘ë‹µ ìƒì„±
    String response = 'ğŸ¢ **ì¶”ì²œ íŒŒíŠ¸ë„ˆì‚¬**: ' + bestPartner.Name;

    if (bestPartner.PartnerRating__c != null) {
      response += ' (í‰ì : ' + bestPartner.PartnerRating__c + '/5)';
    }

    response += '\n\nğŸ“‹ **ì¶”ì²œ ì´ìœ **:\n';
    response += generateRecommendationReasons(opp, bestPartner);

    response += '\n\nğŸ“… **ì˜ˆìƒ ì¼ì •**:\n';
    response += '- ê²¬ì ì„œ ì œì¶œ: 3-5ì¼\n';
    response += '- ë°©ë¬¸ ê²¬ì : 1ì£¼ì¼ ë‚´\n';

    response +=
      '\n\nğŸ’¡ **ë‹¤ìŒ ë‹¨ê³„**: ' +
      bestPartner.Name +
      'ì— ì—°ë½í•˜ì—¬ ìƒì„¸ ë¯¸íŒ…ì„ ì§„í–‰í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.';

    return response;
  }

  // ìµœì  íŒŒíŠ¸ë„ˆì‚¬ ì„ ì •
  private static Account findBestPartner(
    Opportunity opp,
    List<Account> partners
  ) {
    Account bestPartner = partners[0]; // ê¸°ë³¸: í‰ì  ë†’ì€ ìˆœ
    Integer maxScore = 0;

    for (Account partner : partners) {
      Integer score = calculatePartnerScore(opp, partner);
      if (score > maxScore) {
        maxScore = score;
        bestPartner = partner;
      }
    }

    return bestPartner;
  }

  // íŒŒíŠ¸ë„ˆì‚¬ ì ìˆ˜ ê³„ì‚°
  private static Integer calculatePartnerScore(
    Opportunity opp,
    Account partner
  ) {
    Integer score = 0;

    // í‰ì  ì ìˆ˜ (0-50ì )
    if (partner.PartnerRating__c != null) {
      score += Integer.valueOf(partner.PartnerRating__c * 10);
    }

    // ì „ë¬¸ë¶„ì•¼ ë§¤ì¹­ (0-30ì )
    if (opp.ProjectType__c != null && partner.PartnerSpecialty__c != null) {
      if (partner.PartnerSpecialty__c.contains(opp.ProjectType__c)) {
        score += 30;
      }
    }

    // ì§€ì—­ ì ìˆ˜ (0-20ì ) - ìš©ì¸ì‹œ ìš°ì„ 
    if (partner.ABillingCity__c != null) {
      if (partner.ABillingCity__c.equals('ìš©ì¸ì‹œ')) {
        score += 20;
      } else if (partner.ABillingCity__c.contains('ì‹œ')) {
        score += 10;
      }
    }

    return score;
  }

  // ì¶”ì²œ ì´ìœ  ìƒì„±
  private static String generateRecommendationReasons(
    Opportunity opp,
    Account partner
  ) {
    List<String> reasons = new List<String>();

    // ì „ë¬¸ë¶„ì•¼ ë§¤ì¹­
    if (
      opp.ProjectType__c != null &&
      partner.PartnerSpecialty__c != null &&
      partner.PartnerSpecialty__c.contains(opp.ProjectType__c)
    ) {
      reasons.add(opp.ProjectType__c + ' í”„ë¡œì íŠ¸ì— íŠ¹í™”ëœ ì „ë¬¸ ê²½í—˜ ë³´ìœ ');
    } else {
      reasons.add('ë‹¤ì–‘í•œ ì¸í…Œë¦¬ì–´ í”„ë¡œì íŠ¸ ê²½í—˜ìœ¼ë¡œ ê³ í’ˆì§ˆ ì„œë¹„ìŠ¤ ì œê³µ');
    }

    // í‰ì  ê¸°ë°˜
    if (partner.PartnerRating__c != null && partner.PartnerRating__c >= 4.0) {
      reasons.add(
        'ë†’ì€ ê³ ê° ë§Œì¡±ë„ì™€ ê²€ì¦ëœ ì‹œê³µ ì‹¤ë ¥ ë³´ìœ  (í‰ì  ' +
          partner.PartnerRating__c +
          '/5)'
      );
    } else {
      reasons.add('ì•ˆì •ì ì¸ ì‹œê³µ í’ˆì§ˆê³¼ ê³ ê° ì„œë¹„ìŠ¤ ì œê³µ');
    }

    // ì§€ì—­ì  ì ‘ê·¼ì„±
    if (partner.ABillingCity__c != null) {
      reasons.add(
        'ì§€ì—­ì  ì ‘ê·¼ì„±ì´ ìš°ìˆ˜í•¨ (' + partner.ABillingCity__c + ' ì†Œì¬)'
      );
    } else {
      reasons.add('ê²½ê¸°ë„ ë‚´ ìš°ìˆ˜í•œ ì ‘ê·¼ì„±ìœ¼ë¡œ ì‹ ì†í•œ ëŒ€ì‘ ê°€ëŠ¥');
    }

    String result = '';
    for (Integer i = 0; i < reasons.size(); i++) {
      result += (i + 1) + '. ' + reasons[i] + '\n';
    }

    return result.removeEnd('\n');
  }
}
