public with sharing class DesignPartnerRecommendationController {
  @AuraEnabled(cacheable=true)
  public static Map<String, Object> getRecommendationData(Id opportunityId) {
    System.debug('=== getRecommendationData í˜¸ì¶œ ===');

    try {
      // Opportunity ì •ë³´ ì¡°íšŒ
      Opportunity opp = [
        SELECT
          Id,
          Name,
          Customer_Design_Preference__c,
          Budget__c,
          ProjectType__c,
          sf_product__c
        FROM Opportunity
        WHERE Id = :opportunityId
        LIMIT 1
      ];

      System.debug('í”„ë¡œì íŠ¸ ìœ í˜•: ' + opp.ProjectType__c);
      System.debug('ë””ìì¸ ì„ í˜¸: ' + opp.Customer_Design_Preference__c);
      System.debug('ì œí’ˆ: ' + opp.sf_product__c);

      // íŒŒíŠ¸ë„ˆì‚¬ ì¡°íšŒ (Top 3ë§Œ)
      List<Account> partners = [
        SELECT
          Id,
          Name,
          Design_Style_Specialties__c,
          AccountRole__c,
          PartnerSpecialty__c,
          PartnerRating__c
        FROM Account
        WHERE AccountRole__c IN ('ì‹œê³µì—…ì²´', 'ë¦¬ëª¨ë¸ë§', 'ì¸í…Œë¦¬ì–´')
        ORDER BY PartnerRating__c DESC NULLS LAST, Name
        LIMIT 3
      ];

      System.debug('íŒŒíŠ¸ë„ˆ ì¡°íšŒ ê²°ê³¼: ' + partners.size() + 'ê°œ');

      // AI ì¶”ì²œ ìƒì„±
      String aiRecommendation = generateAIRecommendation(opp, partners);

      Map<String, Object> result = new Map<String, Object>();
      result.put('opportunity', opp);
      result.put('partners', partners);
      result.put('aiRecommendation', aiRecommendation);
      return result;
    } catch (Exception e) {
      throw new AuraHandledException('ì¡°íšŒ ì‹¤íŒ¨: ' + e.getMessage());
    }
  }

  // AI ì¶”ì²œ ìƒì„± (í•µì‹¬ ë¡œì§ë§Œ)
  private static String generateAIRecommendation(
    Opportunity opp,
    List<Account> partners
  ) {
    String result = 'ğŸ¤– AI ì¶”ì²œ ê²°ê³¼\n\n';

    // í”„ë¡œì íŠ¸ ì •ë³´
    result += 'ğŸ“‹ í”„ë¡œì íŠ¸: ' + opp.Name + '\n';
    result += 'ğŸ—ï¸ ìœ í˜•: ' + (opp.ProjectType__c ?? 'ë¯¸ì •') + '\n';
    result +=
      'ğŸ¨ ìŠ¤íƒ€ì¼: ' +
      (opp.Customer_Design_Preference__c ?? 'ë¯¸ì •') +
      '\n';
    result += 'ğŸ·ï¸ ì œí’ˆ: ' + (opp.sf_product__c ?? 'ë¯¸ì •') + '\n\n';

    // íŒŒíŠ¸ë„ˆ ì ìˆ˜ ê³„ì‚° ë° ì¶”ì²œ
    List<PartnerScore> scores = new List<PartnerScore>();
    for (Account partner : partners) {
      Integer score = calculateScore(opp, partner);
      scores.add(new PartnerScore(partner, score));
    }
    scores.sort();

    result += 'ğŸ¯ ì¶”ì²œ íŒŒíŠ¸ë„ˆ Top 3\n\n';
    for (Integer i = 0; i < scores.size(); i++) {
      PartnerScore ps = scores[i];
      String icon = i == 0 ? 'ğŸ¥‡' : i == 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';

      result += icon + ' ' + (i + 1) + 'ìˆœìœ„: ' + ps.partner.Name + '\n';
      result += 'ğŸ“Š ì ìˆ˜: ' + ps.score + '/100ì \n';
      result += 'ğŸ’¡ ì´ìœ : ' + getMatchReason(opp, ps.partner) + '\n';
      result += 'â­ ì „ë¬¸ë¶„ì•¼: ' + (ps.partner.AccountRole__c ?? 'ì¢…í•©') + '\n';
      result +=
        'ğŸ¨ ë””ìì¸: ' +
        (ps.partner.Design_Style_Specialties__c ?? 'ë‹¤ì–‘') +
        '\n\n';
    }

    return result;
  }

  // ê°„ë‹¨í•œ ì ìˆ˜ ê³„ì‚°
  private static Integer calculateScore(Opportunity opp, Account partner) {
    Integer score = 50; // ê¸°ë³¸ ì ìˆ˜

    // í”„ë¡œì íŠ¸ íƒ€ì… ë§¤ì¹­ (25ì )
    if (partner.AccountRole__c == opp.ProjectType__c) {
      score += 25;
    } else if (isRelated(partner.AccountRole__c, opp.ProjectType__c)) {
      score += 15;
    }

    // ë””ìì¸ ìŠ¤íƒ€ì¼ ë§¤ì¹­ (15ì )
    if (
      partner.Design_Style_Specialties__c == opp.Customer_Design_Preference__c
    ) {
      score += 15;
    }

    // ì œí’ˆ ë§¤ì¹­ (10ì )
    if (partner.PartnerSpecialty__c == opp.sf_product__c) {
      score += 10;
    }

    // í‰ì  ë³´ë„ˆìŠ¤ (ìµœëŒ€ 10ì )
    if (partner.PartnerRating__c != null) {
      score += Integer.valueOf(partner.PartnerRating__c * 2);
    }

    return Math.min(score, 100);
  }

  // ìœ ì‚¬ ë¶„ì•¼ íŒë³„
  private static Boolean isRelated(String role1, String role2) {
    Set<String> related = new Set<String>{ 'ì‹œê³µì—…ì²´', 'ë¦¬ëª¨ë¸ë§', 'ì¸í…Œë¦¬ì–´' };
    return related.contains(role1) && related.contains(role2);
  }

  // ë§¤ì¹­ ì´ìœ  ìƒì„±
  private static String getMatchReason(Opportunity opp, Account partner) {
    List<String> reasons = new List<String>();

    if (partner.AccountRole__c == opp.ProjectType__c) {
      reasons.add('í”„ë¡œì íŠ¸ ìœ í˜• ì™„ë²½ ë§¤ì¹­');
    }
    if (
      partner.Design_Style_Specialties__c == opp.Customer_Design_Preference__c
    ) {
      reasons.add('ë””ìì¸ ìŠ¤íƒ€ì¼ ì „ë¬¸');
    }
    if (partner.PartnerSpecialty__c == opp.sf_product__c) {
      reasons.add('ì œí’ˆ ì „ë¬¸ ê²½í—˜');
    }
    if (partner.PartnerRating__c != null && partner.PartnerRating__c >= 4.0) {
      reasons.add('ë†’ì€ ê³ ê° ë§Œì¡±ë„');
    }

    return reasons.isEmpty()
      ? 'ì¢…í•©ì  ì„œë¹„ìŠ¤ ì—­ëŸ‰'
      : String.join(reasons, ', ');
  }

  // ì ìˆ˜ ì •ë ¬ìš© ë‚´ë¶€ í´ë˜ìŠ¤
  private class PartnerScore implements Comparable {
    public Account partner;
    public Integer score;

    public PartnerScore(Account partner, Integer score) {
      this.partner = partner;
      this.score = score;
    }

    public Integer compareTo(Object other) {
      PartnerScore otherScore = (PartnerScore) other;
      return otherScore.score - this.score; // ë‚´ë¦¼ì°¨ìˆœ
    }
  }
}
